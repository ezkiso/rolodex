<ion-card class="contact-form-card">
  <ion-card-header>
    <div class="form-header">
      <ion-card-title>
        {{ contact ? 'Editar Contacto' : 'Nuevo Contacto' }}
      </ion-card-title>
      <ion-button 
        fill="clear" 
        size="small" 
        (click)="confirmClose()"
        class="close-button">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>
  </ion-card-header>

  <ion-card-content> 
    <form [formGroup]="contactForm" (ngSubmit)="saveContact()">
      
      <!-- Informaci√≥n b√°sica -->
      <div class="form-section">
        <h3>Informaci√≥n B√°sica</h3>
        
        <ion-item>
          <ion-label position="stacked">Nombre Completo *</ion-label>
          <ion-input 
            formControlName="name"
            placeholder="Ingresa el nombre completo"
            [class.ion-invalid]="contactForm.get('name')?.invalid && contactForm.get('name')?.touched">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Empresa</ion-label>
          <ion-input 
            formControlName="company"
            placeholder="Nombre de la empresa">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Cargo</ion-label>
          <ion-input 
            formControlName="position"
            placeholder="Cargo o posici√≥n">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Email</ion-label>
          <ion-input 
            type="email"
            formControlName="email"
            placeholder="correo@ejemplo.com"
            [class.ion-invalid]="contactForm.get('email')?.invalid && contactForm.get('email')?.touched">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Tel√©fono</ion-label>
          <ion-input 
            type="tel"
            formControlName="phone"
            placeholder="+56 9 1234 5678">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Prioridad *</ion-label>
          <ion-select formControlName="priority" placeholder="Seleccionar prioridad">
            <ion-select-option 
              *ngFor="let priority of priorityOptions" 
              [value]="priority.value">
              {{ priority.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Tags</ion-label>
          <ion-input 
            formControlName="tags"
            placeholder="Separa por comas: Cliente, Importante, Trabajo">
          </ion-input>
        </ion-item>
      </div>

      <!-- Enlaces adicionales -->
      <div class="form-section">
        <div class="section-header">
          <h3>Enlaces Adicionales</h3>
          <ion-button 
            size="small" 
            fill="outline" 
            (click)="addLink()">
            <ion-icon name="add"></ion-icon>
            Agregar
          </ion-button>
        </div>

        <div formArrayName="links">
          <div 
            *ngFor="let linkControl of links.controls; let i = index" 
            [formGroupName]="i"
            class="link-item">
            <ion-grid>
              <ion-row>
                <ion-col size="3">
                  <ion-item>
                    <ion-select formControlName="type" placeholder="Tipo">
                      <ion-select-option 
                        *ngFor="let linkType of linkTypes" 
                        [value]="linkType.value">
                        {{ linkType.label }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
                <ion-col size="7">
                  <ion-item>
                    <ion-input 
                      formControlName="value"
                      [placeholder]="'Ingresa ' + getLinkLabel(linkControl.get('type')?.value)"
                    >
                    </ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="2">
                  <ion-button 
                    fill="clear" 
                    color="danger"
                    size="small"
                    (click)="removeLink(i)">
                    <ion-icon name="trash"></ion-icon>
                  </ion-button>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="10">
                  <ion-item>
                    <ion-input 
                      formControlName="label"
                      placeholder="Etiqueta opcional (ej: Trabajo, Personal)">
                    </ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>
        </div>

        <p *ngIf="links.length === 0" class="no-items">
          No hay enlaces agregados. Haz clic en "Agregar" para a√±adir enlaces adicionales.
        </p>
      </div>

      <!-- Notas con sistema de recordatorios -->
      <div class="form-section">
        <div class="section-header">
          <h3>Notas</h3>
        </div>

        <!-- Formulario para agregar nueva nota -->
        <div class="new-note-section">
          <ion-item>
            <ion-label position="stacked">Tipo de Nota</ion-label>
            <ion-select [formControl]="noteTypeControl">
              <ion-select-option value="note">Nota General</ion-select-option>
              <ion-select-option value="meeting">Reuni√≥n</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Contenido *</ion-label>
            <ion-textarea 
              [formControl]="noteTextControl"
              placeholder="Escribe tu nota aqu√≠..."
              rows="3"
              auto-grow="true">
            </ion-textarea>
          </ion-item>

          <!-- Toggle para activar recordatorio (solo para reuniones) -->
          <ion-item *ngIf="noteTypeControl.value === 'meeting'">
            <ion-toggle 
              [formControl]="enableReminderControl"
              (ionChange)="toggleReminderFields()"
              labelPlacement="end">
              ‚è∞ Activar recordatorio
            </ion-toggle>
          </ion-item>

          <!-- Campos para recordatorio (solo se muestran si est√° activado) -->
          <div *ngIf="noteTypeControl.value === 'meeting' && showReminderFields">
            <ion-item>
              <ion-label position="stacked">Fecha del Recordatorio</ion-label>
              <ion-datetime 
                [formControl]="reminderDateControl"
                presentation="date"
                preferWheel="true"
                locale="es-CL"
                [min]="today"
                placeholder="Seleccionar fecha">
              </ion-datetime>
            </ion-item>

            <ion-item *ngIf="reminderDateControl.value">
              <ion-label position="stacked">Hora del Recordatorio</ion-label>
              <ion-datetime 
                [formControl]="reminderTimeControl"
                presentation="time"
                preferWheel="true"
                locale="es-CL"
                minuteValues="0,15,30,45"
                placeholder="Seleccionar hora">
              </ion-datetime>
            </ion-item>

            <div *ngIf="reminderDateControl.value && reminderTimeControl.value" class="reminder-confirmation">
              <p>‚úÖ Recordatorio programado para: {{ formatReminderDate(combineDateTimePublic(reminderDateControl.value, reminderTimeControl.value).toISOString()) }}</p>
            </div>
          </div>

          <ion-button 
            expand="block" 
            (click)="addNewNote()"
            [disabled]="noteForm.invalid"
            color="secondary">
            <ion-icon name="add"></ion-icon>
            Agregar Nota
          </ion-button>
        </div>

        <!-- Lista de notas existentes -->
        <div formArrayName="notes">
          <div 
            *ngFor="let noteControl of notes.controls; let i = index" 
            [formGroupName]="i"
            class="note-item"
            [class.reminder-note]="isMeetingWithReminder(noteControl.value)">
            
            <ion-item>
              <ion-label>
                <h4>{{ noteControl.value.type === 'meeting' ? 'üìÖ Reuni√≥n' : 'üìù Nota' }}</h4>
                <p>{{ noteControl.value.text }}</p>
                
                <!-- Mostrar recordatorio si existe -->
                <p *ngIf="isMeetingWithReminder(noteControl.value)" 
                   class="reminder-text">
                  ‚è∞ Recordatorio: {{ formatReminderDate(noteControl.value.reminderDate) }}
                </p>
                
                <p class="note-date">{{ formatReminderDate(noteControl.value.date) }}</p>
              </ion-label>
              
              <!-- Bot√≥n para cancelar recordatorio -->
              <ion-button 
                *ngIf="noteControl.value.reminderSet"
                fill="clear"
                color="danger"
                size="small"
                (click)="cancelReminder(i)">
                <ion-icon name="close-circle"></ion-icon>
              </ion-button>
            </ion-item>

            <div class="note-actions">
              <ion-button 
                fill="clear" 
                color="danger"
                size="small"
                (click)="removeNote(i)">
                <ion-icon name="trash"></ion-icon>
                Eliminar
              </ion-button>
            </div>
          </div>
        </div>

        <p *ngIf="notes.length === 0" class="no-items">
          No hay notas agregadas. Completa el formulario arriba y haz clic en "Agregar Nota".
        </p>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="form-actions">
        <ion-button 
          expand="block" 
          type="submit"
          [disabled]="contactForm.invalid"
          color="primary">
          <ion-icon name="save"></ion-icon>
          {{ contact ? 'Actualizar' : 'Guardar' }} Contacto
        </ion-button>

        <ion-button 
          expand="block" 
          fill="outline" 
          type="button"
          (click)="confirmClose()">
          Cancelar
        </ion-button>
      </div>
    </form>
  </ion-card-content>
</ion-card>