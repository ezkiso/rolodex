<ion-card class="contact-form-card">
  <ion-card-header>
    <div class="form-header">
      <ion-card-title>
        {{ contact ? 'Editar Contacto' : 'Nuevo Contacto' }}
      </ion-card-title>
      <ion-button 
        fill="clear" 
        size="small" 
        (click)="confirmClose()"
        class="close-button">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>
  </ion-card-header>

  <ion-card-content> 
    <form [formGroup]="contactForm" (ngSubmit)="saveContact()">
      
      <!-- Informaci√≥n b√°sica -->
      <div class="form-section">
        <h3>Informaci√≥n B√°sica</h3>
        
        <ion-item>
          <ion-label position="stacked">Nombre Completo *</ion-label>
          <ion-input 
            formControlName="name"
            placeholder="Ingresa el nombre completo"
            [class.ion-invalid]="contactForm.get('name')?.invalid && contactForm.get('name')?.touched">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Empresa</ion-label>
          <ion-input 
            formControlName="company"
            placeholder="Nombre de la empresa">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Cargo</ion-label>
          <ion-input 
            formControlName="position"
            placeholder="Cargo o posici√≥n">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Email</ion-label>
          <ion-input 
            type="email"
            formControlName="email"
            placeholder="correo@ejemplo.com"
            [class.ion-invalid]="contactForm.get('email')?.invalid && contactForm.get('email')?.touched">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Tel√©fono</ion-label>
          <ion-input 
            type="tel"
            formControlName="phone"
            placeholder="+56 9 1234 5678">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Prioridad *</ion-label>
          <ion-select formControlName="priority" placeholder="Seleccionar prioridad">
            <ion-select-option 
              *ngFor="let priority of priorityOptions" 
              [value]="priority.value">
              {{ priority.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Tags</ion-label>
          <ion-input 
            formControlName="tags"
            placeholder="Separa por comas: Cliente, Importante, Trabajo">
          </ion-input>
        </ion-item>
      </div>

      <!-- Enlaces adicionales -->
      <div class="form-section">
        <div class="section-header">
          <h3>Enlaces Adicionales</h3>
          <ion-button 
            size="small" 
            fill="outline" 
            (click)="addLink()">
            <ion-icon name="add"></ion-icon>
            Agregar
          </ion-button>
        </div>

        <div formArrayName="links">
          <div 
            *ngFor="let linkControl of links.controls; let i = index" 
            [formGroupName]="i"
            class="link-item">
            <ion-grid>
              <ion-row>
                <ion-col size="3">
                  <ion-item>
                    <ion-select formControlName="type" placeholder="Tipo">
                      <ion-select-option 
                        *ngFor="let linkType of linkTypes" 
                        [value]="linkType.value">
                        {{ linkType.label }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </ion-col>
                <ion-col size="7">
                  <ion-item>
                    <ion-input 
                      formControlName="value"
                      [placeholder]="'Ingresa ' + getLinkLabel(linkControl.get('type')?.value)"
                    >
                    </ion-input>
                  </ion-item>
                </ion-col>
                <ion-col size="2">
                  <ion-button 
                    fill="clear" 
                    color="danger"
                    size="small"
                    (click)="removeLink(i)">
                    <ion-icon name="trash"></ion-icon>
                  </ion-button>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="10">
                  <ion-item>
                    <ion-input 
                      formControlName="label"
                      placeholder="Etiqueta opcional (ej: Trabajo, Personal)">
                    </ion-input>
                  </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>
        </div>

        <p *ngIf="links.length === 0" class="no-items">
          No hay enlaces agregados. Haz clic en "Agregar" para a√±adir enlaces adicionales.
        </p>
      </div>

      <!-- Reemplaza la secci√≥n de Notas en tu contact-form.component.html con esto -->

      <!-- Notas con sistema de recordatorios -->
      <div class="form-section">
        <div class="section-header">
          <h3>Notas</h3>
        </div>

        <!-- Formulario para agregar nueva nota -->
        <div class="new-note-section">
          <ion-item>
            <ion-label position="stacked">Tipo de Nota</ion-label>
            <ion-select [formControl]="noteTypeControl">
              <ion-select-option value="note">üìù Nota General</ion-select-option>
              <ion-select-option value="meeting">üìÖ Reuni√≥n</ion-select-option>
              <ion-select-option value="meeting-bullets">üìã Reuni√≥n (Vi√±etas)</ion-select-option>
              <ion-select-option value="meeting-checklist">‚úÖ Reuni√≥n (Checklist)</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Campo de texto para notas normales y con vi√±etas -->
          <ion-item *ngIf="noteTypeControl.value !== 'meeting-checklist'">
            <ion-label position="stacked">
              Contenido * 
              <span *ngIf="noteTypeControl.value === 'meeting-bullets'" class="helper-text">
                (Las l√≠neas se convertir√°n autom√°ticamente en vi√±etas)
              </span>
            </ion-label>
            <ion-textarea 
              [formControl]="noteTextControl"
              [placeholder]="noteTypeControl.value === 'meeting-bullets' ? 'Escribe cada punto en una nueva l√≠nea...' : 'Escribe tu nota aqu√≠...'"
              rows="3"
              auto-grow="true">
            </ion-textarea>
          </ion-item>

          <!-- Checklist para reuniones tipo checklist -->
          <div *ngIf="noteTypeControl.value === 'meeting-checklist'" class="checklist-builder">
            <ion-item>
              <ion-label position="stacked">T√≠tulo del Checklist *</ion-label>
              <ion-input 
                [formControl]="noteTextControl"
                placeholder="Ej: Objetivos de la reuni√≥n">
              </ion-input>
            </ion-item>

            <div class="checklist-input-section">
              <ion-item>
                <ion-label position="stacked">Agregar item al checklist</ion-label>
                <ion-input 
                  [(ngModel)]="newChecklistItem"
                  [ngModelOptions]="{standalone: true}"
                  placeholder="Escribe un item y presiona +"
                  (keyup.enter)="addChecklistItem()">
                </ion-input>
                <ion-button 
                  slot="end" 
                  fill="clear" 
                  (click)="addChecklistItem()"
                  [disabled]="!newChecklistItem.trim()">
                  <ion-icon name="add-circle"></ion-icon>
                </ion-button>
              </ion-item>

              <!-- Lista de items del checklist -->
              <div class="checklist-items-preview" *ngIf="checklistItemsControl.value?.length > 0">
                <p class="checklist-label">Items agregados:</p>
                <div 
                  *ngFor="let item of checklistItemsControl.value" 
                  class="checklist-item-preview">
                  <ion-icon name="checkbox-outline"></ion-icon>
                  <span>{{ item.text }}</span>
                  <ion-button 
                    fill="clear" 
                    size="small" 
                    color="danger"
                    (click)="removeChecklistItem(item.id)">
                    <ion-icon name="close-circle"></ion-icon>
                  </ion-button>
                </div>
              </div>

              <p *ngIf="checklistItemsControl.value?.length === 0" class="no-items-small">
                No hay items en el checklist. Agrega al menos uno.
              </p>
            </div>
          </div>

          <!-- Toggle para activar recordatorio (solo para reuniones) -->
          <ion-item *ngIf="noteTypeControl.value === 'meeting' || noteTypeControl.value === 'meeting-bullets' || noteTypeControl.value === 'meeting-checklist'">
            <ion-toggle 
              [formControl]="enableReminderControl"
              (ionChange)="toggleReminderFields()"
              labelPlacement="end">
              ‚è∞ Activar recordatorio
            </ion-toggle>
          </ion-item>

          <!-- Campos para recordatorio (solo se muestran si est√° activado) -->
          <div *ngIf="(noteTypeControl.value === 'meeting' || noteTypeControl.value === 'meeting-bullets' || noteTypeControl.value === 'meeting-checklist') && showReminderFields">
            <ion-item>
              <ion-label position="stacked">Fecha del Recordatorio</ion-label>
              <ion-datetime 
                [formControl]="reminderDateControl"
                presentation="date"
                preferWheel="true"
                locale="es-CL"
                [min]="today"
                placeholder="Seleccionar fecha">
              </ion-datetime>
            </ion-item>

            <ion-item *ngIf="reminderDateControl.value">
              <ion-label position="stacked">Hora del Recordatorio</ion-label>
              <ion-datetime 
                [formControl]="reminderTimeControl"
                presentation="time"
                preferWheel="true"
                locale="es-CL"
                minuteValues="0,15,30,45"
                placeholder="Seleccionar hora">
              </ion-datetime>
            </ion-item>

            <div *ngIf="reminderDateControl.value && reminderTimeControl.value" class="reminder-confirmation">
              <p>‚úÖ Recordatorio programado para: {{ formatReminderDate(combineDateTimePublic(reminderDateControl.value, reminderTimeControl.value).toISOString()) }}</p>
            </div>
          </div>

          <ion-button 
            expand="block" 
            (click)="addNewNote()"
            [disabled]="noteForm.invalid || (noteTypeControl.value === 'meeting-checklist' && checklistItemsControl.value?.length === 0)"
            color="secondary">
            <ion-icon name="add"></ion-icon>
            Agregar Nota
          </ion-button>
        </div>

        <!-- Lista de notas existentes -->
        <div formArrayName="notes">
          <div 
            *ngFor="let noteControl of notes.controls; let i = index" 
            [formGroupName]="i"
            class="note-item"
            [class.reminder-note]="isMeetingWithReminder(noteControl.value)">
            
            <ion-item>
              <ion-label>
                <h4>
                  <span *ngIf="noteControl.value.type === 'meeting'">üìÖ Reuni√≥n</span>
                  <span *ngIf="noteControl.value.type === 'meeting-bullets'">üìã Reuni√≥n (Vi√±etas)</span>
                  <span *ngIf="noteControl.value.type === 'meeting-checklist'">‚úÖ Reuni√≥n (Checklist)</span>
                  <span *ngIf="noteControl.value.type === 'note'">üìù Nota</span>
                </h4>
                
                <!-- Mostrar texto con vi√±etas si es meeting-bullets -->
                <div *ngIf="noteControl.value.type === 'meeting-bullets'" class="note-bullets">
                  <p *ngFor="let line of noteControl.value.text.split('\n')" class="bullet-line">
                    {{ line }}
                  </p>
                </div>
                
                <!-- Mostrar checklist si es meeting-checklist -->
                <div *ngIf="noteControl.value.type === 'meeting-checklist'">
                  <p class="checklist-title">{{ noteControl.value.text }}</p>
                  <div class="checklist-items" *ngIf="noteControl.value.checklistItems">
                    <div *ngFor="let item of noteControl.value.checklistItems" class="checklist-item-readonly">
                      <ion-icon name="checkbox-outline"></ion-icon>
                      <span>{{ item.text }}</span>
                    </div>
                  </div>
                </div>
                
                <!-- Texto normal para otros tipos -->
                <p *ngIf="noteControl.value.type !== 'meeting-bullets' && noteControl.value.type !== 'meeting-checklist'">
                  {{ noteControl.value.text }}
                </p>
                
                <!-- Mostrar recordatorio si existe -->
                <p *ngIf="isMeetingWithReminder(noteControl.value)" 
                   class="reminder-text">
                  ‚è∞ Recordatorio: {{ formatReminderDate(noteControl.value.reminderDate) }}
                </p>
                
                <p class="note-date">{{ formatReminderDate(noteControl.value.date) }}</p>
              </ion-label>
              
              <!-- Bot√≥n para cancelar recordatorio -->
              <ion-button 
                *ngIf="noteControl.value.reminderSet"
                fill="clear"
                color="danger"
                size="small"
                (click)="cancelReminder(i)">
                <ion-icon name="close-circle"></ion-icon>
              </ion-button>
            </ion-item>

            <div class="note-actions">
              <ion-button 
                fill="clear" 
                color="danger"
                size="small"
                (click)="removeNote(i)">
                <ion-icon name="trash"></ion-icon>
                Eliminar
              </ion-button>
            </div>
          </div>
        </div>

        <p *ngIf="notes.length === 0" class="no-items">
          No hay notas agregadas. Completa el formulario arriba y haz clic en "Agregar Nota".
        </p>
      </div>
      <!-- Botones de acci√≥n -->
      <div class="form-actions">
        <ion-button 
          expand="block" 
          type="submit"
          [disabled]="contactForm.invalid"
          color="primary">
          <ion-icon name="save"></ion-icon>
          {{ contact ? 'Actualizar' : 'Guardar' }} Contacto
        </ion-button>

        <ion-button 
          expand="block" 
          fill="outline" 
          type="button"
          (click)="confirmClose()">
          Cancelar
        </ion-button>
      </div>
    </form>
  </ion-card-content>
</ion-card>